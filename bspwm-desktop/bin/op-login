#!/bin/bash
set -e
set -o pipefail

: "${PINENTRY_PROGRAM:=pinentry-rofi}"

login() {
  OP_SESS_EVAL=$($PINENTRY_PROGRAM <<< GETPIN | grep -oP 'D \K.*' | op signin my)
  eval $OP_SESS_EVAL
  echo "$OP_SESS_EVAL" | tee ~/.op/session
}

check-op-status() {
  set +e
  op list vaults >/dev/null
  LOGGED_IN=${PIPESTATUS[0]}
  set -e

  if [ $LOGGED_IN -eq 127 ]; then
    echo "1password CLI tool 'op' not found"
    exit 2
  fi

  if [ ! $LOGGED_IN -eq 0 ]; then
    login
    check-op-status
  else
    cat ~/.op/session
  fi
}

source ~/.op/session

if [[ ! -v OP_SESSION_my ]]; then
  login
fi

check-op-status
